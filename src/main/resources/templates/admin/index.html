<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/admin/index.css">
    <link rel="stylesheet" href="/css/globel.css">
    <link rel="stylesheet" href="/css/element.css">
    <link rel="stylesheet" href="/css/frame.css">
    <link rel="stylesheet" href="/css/lTable.css">
</head>

<body>
<div id="app">
    <!-- 遮罩数据操作 -->
    <div class="editMark" id="editMark">
        <div class="tableEdit" id="tableEdit">
            <div class="editMain" id="editMain"></div>
        </div>
    </div>
    <div class="adminNav">
        <p class="navTitle"><i class="el-icon-user-solid"></i> 管理端</p>
        <div class="userInformation">
            <p id="nowUser">当前用户:</p>
            <el-button class="userLoginOut" @click="loginOut" type="text" icon="el-icon-switch-button">登出</el-button>
        </div>
    </div>
    <div class="adminBody">

        <el-row class="adminList">
            <el-menu default-active="1" class="el-menu-vertical-demo" @select="handleSelect"
                     background-color="#545c64" text-color="#fff" active-text-color="#ffd04b">
                <el-menu-item index="1">
                    <i class="el-icon-user"></i>
                    <span slot="title">学生用户列表</span>
                </el-menu-item>
                <el-menu-item index="2">
                    <i class="el-icon-suitcase-1"></i>
                    <span slot="title">教师用户列表</span>
                </el-menu-item>
                <el-menu-item index="3">
                    <i class="el-icon-edit-outline"></i>
                    <span slot="title">选题管理</span>
                </el-menu-item>
                <el-menu-item index="5">
                    <i class="el-icon-chat-square"></i>
                    <span slot="title">公告管理</span>
                </el-menu-item>
                <el-menu-item index="6">
                    <i class="el-icon-document"></i>
                    <span slot="title">模板文件管理</span>
                </el-menu-item>
                <el-menu-item index="7">
                    <i class="el-icon-document"></i>
                    <span slot="title">学生提交文件管理</span>
                </el-menu-item>
                <el-menu-item index="8">
                    <i class="el-icon-date"></i>
                    <span slot="title">毕业设计流程日期管理</span>
                </el-menu-item>
                <el-menu-item index="9">
                    <i class="el-icon-user"></i>
                    <span slot="title">用户管理</span>
                </el-menu-item>
            </el-menu>
        </el-row>
        <div class="adminData">
            <div id="listTool" class="listTool"></div>
            <!-- 主体 -->
            <div class="mainContent" id="mainContent">
            </div>
            <!-- 分页 -->
            <el-pagination id="pagination" class="listPagination" background
                           @current-change="handleCurrentChange"  :current-page="pageInfo.nowPage" :page-size="pageInfo.pageSize" :total="pageInfo.totalData"
                           layout="prev, pager, next, jumper">
            </el-pagination>

        </div>
    </div>
</div>
</body>
<script src="/js/tool.js" type="module"></script>
<script src="/js/staticValue.js" type="module"></script>
<script src="/js/tableModel.js" type="module"></script>
<script src="/js/vue.js" type="module"></script>
<script src="/js/element.js" type="module"></script>
<script src="/js/axios.js"></script>
<script type="module">

    import {tools} from '/js/tool.js';
    import {staticValue} from '/js/staticValue.js';
    import {tableModel} from '/js/tableModel.js';

    (async () => {
        tools.setDefaultPage({
            title: '标题',
            topicSelect: ['none', 'none'],
            listToolAddAll: 'none',
            importUri:'/import/student'
        });
        await tools.setPage('editMain', '/view/form/none.html');//初始加载页
        await tools.setPage('mainContent', '/view/data/studentTable.html');
        await tools.setPage('listTool', '/view/listTool.html', {title: '学生用户管理', listToolAddAll: 'block'});
        let studentData = await tools.getAxiosData('/student/list?page=1&pageSize=8');//获取数据
        tools.$('#tableDate').innerHTML = await tableModel.getStudentTableData(studentData['data']['data']);//绑定数据

        var app = Vue.extend({
            data() {
                return {
                    //多文件上传列表
                    fileList: [],
                    pageInfo:{
                        pageSize: 8,
                        nowPage:1,
                        totalData: studentData['data']['total'],
                    },
                    topicTeachers: [
                        {
                            key: 0,
                            choseTeacher: '全选',
                            label: '全选'
                        }, {
                            key: 1,
                            choseTeacher: '王老师',
                            label: '王老师'
                        }, {
                            key: 2,
                            choseTeacher: '李老师',
                            label: '李老师'
                        }, {
                            key: 3,
                            choseTeacher: '陈老师',
                            label: '蚵仔煎'
                        }, {
                            key: 4,
                            choseTeacher: '张老师',
                            label: '龙须面'
                        }, {
                            key: 5,
                            choseTeacher: '杨老师',
                            label: '北京烤鸭'
                        }],
                    choseTeacher:'',
                    //编辑用户表单
                    //学生
                    studentEdit: {
                        studentName: '',
                        studentGarden: '',
                        studentDepartment: ''
                    },
                    //教师
                    teacherEdit: {
                        studentName: '',
                        studentDepartment: ''
                    },

                    //添加用户表单

                    //学生
                    studentAddRule: {
                        studentId: [
                            { required: true, message: '请输入学生学号', trigger: 'blur' }
                        ],
                        studentName: [
                            { required: true, message: '请输入学生姓名', trigger: 'blur' }
                        ],
                        studentGarden: [
                            { required: true, message: '请输入学生班级', trigger: 'blur' }
                        ],
                        studentDepartment: [
                            { required: true, message: '请输入学生系部', trigger: 'blur' }
                        ]
                    },
                    studentAdd: {
                        studentId:'',
                        studentName: '',
                        studentGarden: '',
                        studentDepartment: ''
                    },

                    //教师
                    teacherAddRule: {
                        teacherId:[
                            { required: true, message: '请输入教师工号', trigger: 'blur' }
                        ],
                        teacherName: [
                            { required: true, message: '请输入教师姓名', trigger: 'blur' }
                        ],
                        teacherDepartment: [
                            { required: true, message: '请输入教师系部', trigger: 'blur' }
                        ]
                    },
                    teacherAdd: {
                        teacherId:'',
                        teacherName: '',
                        teacherDepartment: ''
                    },

                    //选题
                    topicAdd:{
                        topicId:'',
                        topicContent:'',
                        topicTeacher:'',
                        topicDifficult:'',
                        topicSource:'',
                        topicTags:[],
                        topicOneTag:''
                    },
                    topicAddRule:{

                    },
                    //教师下拉列表
                    topicSelect:{
                        teacher:[],
                    },
                    topicTagEdit:{
                        topicTags:[],
                        topicOneTag:''
                    },
                    // 编辑选题
                    topicEdit:{
                        topicId:'',
                        topicContent:'',
                        topicTeacher:'',
                        topicDifficult:'',
                        topicSource:'',
                    },
                    //公告
                    noticeAdd:{
                        noticeContent:''
                    },
                    noticeAddRule:{
                        noticeContent:[
                            { required: true, message: '请输入公告内容', trigger: 'blur' }
                        ]
                    },
                    noticeEdit:{
                        noticeContent:''
                    }
                }
            },
            mounted:function(){
                //获取当前登录的用户
                if(tools.getCookie("loginUserName") != ''){
                    tools.$('#nowUser').innerHTML = '当前用户:' + tools.getCookie("loginUserName");
                }else{
                    tools.setTimeOutP(3000,()=>{
                        this.$message.error('请登录,3秒后跳转至登录页');
                    }).then(()=>{
                        tools.jump('/');
                    });
                }
                //入口this
                if(this['$el'].getAttribute('id') == 'app'){
                     staticValue.setThat(this);
                }
                //主页this
                if(this['$el'].getAttribute('id') == 'mainContent'){
                    staticValue.setMainContentThis(this);
                }
                //工具栏this
                if(this['$el'].getAttribute('id') == 'listTool'){
                    staticValue.setListToolThis(this);
                }
                //编辑添加删除页this
                if(this['$el'].getAttribute('id') == 'editMain'){
                    staticValue.setEditMainThis(this);
                }
            },
            methods: {
                //左栏选择
                handleSelect(key, keyPath) {
                    staticValue.setCurrentPage(key);//设置当前页面
                    tools.$('#pagination').style.display = 'block';//翻页初始存在
                    //学生用户列表
                    if (key == 1) {
                        tools.setTimeOutP(300, async () => {
                            tools.$('#mainContent').style.opacity = '0';
                        }).then(async val => {
                            await tools.setPage('listTool', '/view/listTool.html', {
                                title: '学生用户管理',
                                listToolAddAll: 'block'
                            });
                            await tools.setPage('mainContent', '/view/data/studentTable.html');
                            let studentData = await tools.getAxiosData('/student/list?page=1&pageSize=8');
                            tools.$('#tableDate').innerHTML = await tableModel.getStudentTableData(studentData['data']['data']);
                            new app().$mount("#mainContent");
                            new app().$mount("#listTool");
                            tools.$('#mainContent').style.opacity = '1';
                            this.refreshTables(1,studentData['data']['total'],8);
                        });
                    }

                    //教师用户列表
                    if (key == 2) {
                        tools.setTimeOutP(300, async () => {
                            tools.$('#mainContent').style.opacity = '0';
                        }).then(async val => {
                            await tools.setPage('listTool', '/view/listTool.html', {
                                title: '教师用户管理',
                                listToolAddAll: 'block'
                            });
                            await tools.setPage('mainContent', '/view/data/teacherTable.html');
                            let teacherData = await tools.getAxiosData('/teacher/list?page=1&pageSize=8');
                            tools.$('#tableDate').innerHTML = await tableModel.getTeacherTableData(teacherData['data']['data']);
                            new app().$mount("#mainContent");
                            new app().$mount("#listTool");
                            tools.$('#mainContent').style.opacity = '1';
                            this.refreshTables(1,teacherData['data']['total'],8);
                        });
                    }

                    //选题管理
                    if (key == 3) {
                        tools.setTimeOutP(300, async () => {
                            tools.$('#mainContent').style.opacity = '0';
                        }).then(async val => {
                            await tools.setPage('listTool', '/view/listTool.html', {
                                title: '选题管理',
                                topicSelect: ['block', 'block']
                            });
                            await tools.setPage('mainContent', '/view/data/selectTopicTable.html');
                            let subjectData = await tools.getAxiosData('/subject/list?page=1&pageSize=4');
                            tools.$('#tableDate').innerHTML = await tableModel.getTopicTableData(subjectData['data']['data']);
                            new app().$mount("#mainContent");
                            new app().$mount("#listTool");
                            tools.$('#mainContent').style.opacity = '1';
                            this.refreshTables(1,subjectData['data']['total'],4);
                        });
                    }
                    //公告管理
                    if (key == 5) {
                        tools.setTimeOutP(300, async () => {
                            tools.$('#mainContent').style.opacity = '0';
                            tools.$('#pagination').style.display = 'none';//翻页隐藏
                        }).then(async val => {
                            await tools.setPage('listTool', '/view/listTool.html', {title: '公告管理'});
                            await tools.setPage('mainContent', '/view/data/noticeManage.html');
                            new app().$mount("#mainContent");
                            new app().$mount("#listTool");
                            tools.$('#mainContent').style.opacity = '1';
                            this.refreshTables(0,0,0);
                        });
                    }
                },

                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //                   编辑页面                     //
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //编辑页面
                showEdit(data = '',index = '1') {
                    tools.setTimeOutP(0, async () => {
                        tools.$('#editMark').style.display = 'block';
                        //学生页面编辑一项
                        if (staticValue.getCurrentPage() == 1) {
                            await tools.setPage('editMain', '/view/form/studentOneEdit.html');
                            new app().$mount('#editMain');
                            //数据为默认选中的数据
                            let studentData = await tools.getAxiosData(`/student/list?page=${staticValue.getPageNumber()}&pageSize=8`);
                            studentData['data']['data'].forEach((items,index)=>{
                                if(items['id'] === data){
                                    tools.$('#studentName').value = items['name'];
                                    tools.$('#studentGarden').value =  items['classname'];
                                    tools.$('#studentDepartment').value =  items['department'];
                                    tools.inputIsNull('#studentName','blur');//判空校验
                                    tools.inputIsNull('#studentGarden','blur');//判空校验
                                    tools.inputIsNull('#studentDepartment','blur');//判空校验
                                    staticValue.setChoseId(items['id']);
                                }
                            });
                        }

                        //教师页面编辑一项
                        if (staticValue.getCurrentPage() == 2) {
                            await tools.setPage('editMain', '/view/form/teacherOneEdit.html');
                            new app().$mount('#editMain');
                            //数据为默认选中的数据
                            let teacherData = await tools.getAxiosData(`/teacher/list?page=${staticValue.getPageNumber()}&pageSize=8`);
                            teacherData['data']['data'].forEach((items,index)=>{
                                if(items['id'] === data){
                                    tools.$('#teacherName').value = items['name'];
                                    tools.$('#teacherDepartment').value =  items['department'];
                                    tools.inputIsNull('#teacherName','blur');//判空校验
                                    tools.inputIsNull('#teacherDepartment','blur');//判空校验
                                    staticValue.setChoseId(items['id']);
                                }
                            });
                        }
                        //选题页面编辑一项
                        if (staticValue.getCurrentPage() == 3) {
                            staticValue.setChoseId(data);//设置id
                            //编辑选题
                            if(index == 1){
                                await tools.setPage('editMain', '/view/form/topicOneEdit.html');
                                new app().$mount('#editMain');
                                // 初始化数据,数据为默认选中的数据
                                this.teacherSelectList();//初始化教师列表
                                let subjectData = await tools.getAxiosData(`/subject/list?page=${staticValue.getPageNumber()}&pageSize=4`);
                                console.log(subjectData['data']['data']);
                                subjectData['data']['data'].forEach((items,index)=>{
                                    if(items['id'] === staticValue.getChoseId()){
                                        let dataDifficulty = items['difficult'] == '0'?'容易':items['difficult'] == '1'?'普通':items['difficult'] == '2'?'困难':'?';//难度
                                        tools.$('#topicId').value = items['title'];
                                        tools.$('#topicContent').value =  items['content'];
                                        tools.$('#topicSource').value =  items['source'];
                                        tools.$('#topicTeacher').value =  items['teacherName'];
                                        tools.$('#topicTeacher').setAttribute('defaultTeacherId',items['teacherId']);//设置默认teacherId
                                        tools.$('#topicDifficult').value =  dataDifficulty;
                                        tools.$('#topicDifficult').setAttribute('defaultDifficult',items['difficult']);//设置默认难度
                                        tools.inputIsNull('#topicId','blur');//判空校验
                                        tools.inputIsNull('#topicContent','blur');//判空校验
                                        tools.inputIsNull('#topicSource','blur');//判空校验
                                    }
                                });
                            }
                            //编辑标签
                            if(index == 2){
                                await tools.setPage('editMain', '/view/form/topicTagEdit.html');
                                new app().$mount('#editMain');

                                //初始化
                                let tipData = await tools.getAxiosData(`/tag/list?subjectId=${staticValue.getChoseId()}`);
                                staticValue.getThat().$set(staticValue.getThat().topicTagEdit,'topicTags',tipData['data']['data'])
                                let tagsArr = staticValue.getThat().topicTagEdit['topicTags'];//标签数组
                                staticValue.getThat().topicTagEdit['topicTags'].forEach((items, index)=>{
                                    //添加小标签
                                    let tagDiv=document.createElement("div");
                                    tagDiv.className = 'nmTag';
                                    tagDiv.innerHTML = `${items['name']}
                                                <div id="removeTag_${items['id'].toString()}" class="nmTagDelete" val="${items['name']}">
                                                    <i class="el-icon-close"></i>
                                                </div>`;
                                    tools.$(`#topicTagsExit`).appendChild(tagDiv);
                                    //添加标签删除功能
                                    tools.$(`#removeTag_${items['id'].toString()}`).addEventListener('click',function(){
                                        axios.post('/tag/delete',tools.buildFormData({tagId:items['id'].toString(),subjectId:staticValue.getChoseId()})).then(val=>{
                                            let id = val['data']['id'];
                                            if(id == 1){
                                                staticValue.getThat().$message.success("删除成功");
                                                //删除数组的值
                                                tagsArr.forEach((items,index)=>{
                                                    if(items['value'] == this.getAttribute('val') || items['name'] == this.getAttribute('val') ){
                                                        delete tagsArr[index];
                                                    }
                                                });
                                                this.parentNode.parentNode.removeChild(this.parentNode);//删除节点
                                            }
                                            if(id == 2){
                                                this.$message.error("格式化错误");
                                            }
                                            if(id == 3){
                                                this.$message.error("数据库错误");
                                            }
                                        });
                                    });
                                });
                            }
                        }
                        //公告页面编辑一项
                        if (staticValue.getCurrentPage() == 5) {
                            await tools.setPage('editMain', '/view/form/noticeOneEdit.html');
                            new app().$mount('#editMain');

                            //数据为默认选中的数据
                            let noticeData = await tools.getAxiosData(`/announcement/list`);
                            noticeData['data']['data'].forEach((items,index)=>{
                                if(items['id'] === data){
                                    tools.$('#noticeContent').value = items['content'];
                                    tools.inputIsNull('#noticeContent','blur');//判空校验
                                    staticValue.setChoseId(items['id']);
                                }
                            });
                        }
                    }).then(val => {
                        tools.$('#editMark').style.opacity = '1';
                    })
                },
                //关闭编辑
                closeEdit() {
                    tools.setTimeOutP(300, () => {
                        tools.$('#editMark').style.opacity = '0';
                    }).then(async val => {
                        tools.$('#editMark').style.display = 'none';
                        await tools.setPage('editMain', '/view/form/none.html');
                        new app().$mount("#editMain");
                    })
                },
                //关闭编辑并刷新
                closeEditAndRefresh(){
                    tools.setTimeOutP(300, () => {
                        tools.$('#editMark').style.opacity = '0';
                    }).then(async val => {
                        tools.$('#editMark').style.display = 'none';
                        await tools.setPage('editMain', '/view/form/none.html');
                        new app().$mount("#editMain");
                        this.refreshBtn();
                    })
                },
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //                    添加页面                    //
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //添加或新建
                addItems() {

                    tools.setTimeOutP(0, async () => {
                        tools.$('#editMark').style.display = 'block';
                        //学生添加页面
                        if (staticValue.getCurrentPage() == 1) {
                            await tools.setPage('editMain', '/view/form/studentOneImport.html');
                            new app().$mount("#editMain");
                        }
                        //教师添加页面
                        if (staticValue.getCurrentPage() == 2) {
                            await tools.setPage('editMain', '/view/form/teacherOneImport.html');
                            new app().$mount("#editMain");

                        }
                        //选题添加页面
                        if (staticValue.getCurrentPage() == 3) {
                            await tools.setPage('editMain', '/view/form/topicOneImport.html');
                            new app().$mount("#editMain");
                            this.teacherSelectList();//初始化教师列表
                        }
                        //公告添加页面
                        if (staticValue.getCurrentPage() == 5) {
                            await tools.setPage('editMain', '/view/form/noticeOneImport.html');
                            new app().$mount("#editMain");
                        }
                    }).then(val => {
                        tools.$('#editMark').style.opacity = '1';
                    });
                },
                //批量添加或新建
                addItemsAll() {
                    tools.setTimeOutP(0, async () => {
                        tools.$('#editMark').style.display = 'block';
                        //学生页面上传多项
                        if (staticValue.getCurrentPage() == 1) {
                            await tools.setPage('editMain', '/view/form/usersImport.html',{importUri:'/import/student'});
                            new app().$mount("#editMain");
                        }
                        //教师页面上传多项
                        if (staticValue.getCurrentPage() == 2) {
                            await tools.setPage('editMain', '/view/form/usersImport.html',{importUri:'/import/teacher'});
                            new app().$mount("#editMain");
                        }

                    }).then(val => {
                        tools.$('#editMark').style.opacity = '1';
                    });
                },

                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //                    删除功能                    //
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //表格删除
                deleteList(data) {
                    staticValue.setChoseId(data);
                    tools.setTimeOutP(0, async () => {
                        tools.$('#editMark').style.display = 'block';
                        //学生页面删除
                        if (staticValue.getCurrentPage() == 1) {
                            await tools.setPage('editMain', '/view/form/studentDelete.html');
                            new app().$mount("#editMain");
                        }

                        //教师页面删除
                        if (staticValue.getCurrentPage() == 2) {
                            await tools.setPage('editMain', '/view/form/teacherDelete.html');
                            new app().$mount("#editMain");
                        }

                        //选题页面删除
                        if (staticValue.getCurrentPage() == 3) {
                            await tools.setPage('editMain', '/view/form/topicDelete.html');
                            new app().$mount("#editMain");
                        }

                        //公告页面删除
                        if (staticValue.getCurrentPage() == 5) {
                            await tools.setPage('editMain', '/view/form/noticeDelete.html');
                            new app().$mount("#editMain");
                        }
                    }).then(val => {
                        tools.$('#editMark').style.opacity = '1';
                    })
                },

                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //                    表单提交                    //
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //多用户提交文件
                usersSubmitUpload() {
                    this.$refs.upload.submit();
                },
                //学生修改表单
                studentEditForm(){
                    if(tools.inputIsNullValue('#studentName')
                    &&tools.inputIsNullValue('#studentGarden')
                    &&tools.inputIsNullValue('#studentDepartment')){
                        let postData = {
                            name: tools.$('#studentName').value,
                            classname: tools.$('#studentGarden').value,
                            department: tools.$('#studentDepartment').value,
                            id:staticValue.getChoseId()
                        };
                        axios.post('/student/set',postData).then(val=>{
                            if(val['data']['id'] == '1'){
                                this.$message.success("修改成功");
                                this.refreshTableItems();
                                this.closeEdit();//关闭表单页面
                            }
                            if(val['data']['id'] == '2'){
                                this.$message.error("修改失败,数据库错误");
                            }
                        }).catch(err=>{
                            this.$message.error("修改失败");
                        });
                    }else{
                        this.$message.error("请填写完整信息");
                    }
                },
                //学生添加表单
                studentAddForm(formName){
                    this.$refs[formName].validate((valid) => {
                        if (valid) {
                            let postData = {
                                studentId:this.studentAdd['studentId'],
                                name: this.studentAdd['studentName'],
                                classname: this.studentAdd['studentGarden'],
                                department: this.studentAdd['studentDepartment'],
                            };
                            axios.post('/student/add', postData).then(val=>{
                                if(val['data']['id'] == 1){
                                    this.$message.success("添加成功");
                                    this.refreshTableItems();
                                    this.closeEdit();//关闭表单页面
                                }
                                if(val['data']['id'] == 2){
                                    this.$message.error("格式化错误");
                                }
                                if(val['data']['id'] == 3){
                                    this.$message.error("字段不能为空");
                                }
                                if(val['data']['id'] == 4){
                                    this.$message.error("数据库错误");
                                }

                            }).catch(err=>{
                                this.$message.error("添加失败");
                            });

                        } else {
                            this.$message.error("请填写完整信息");
                            return false;
                        }
                    });
                },
                //学生删除
                deleteStudent(){
                    axios.post('/student/delete',tools.buildFormData({id:staticValue.getChoseId()})).then(async val=>{
                        if(val['data']['id'] == 1){
                            this.$message.success("删除成功");
                            this.refreshBtn();
                            this.closeEdit();//关闭表单页面
                        }
                        if(val['data']['id'] == 2){
                            this.$message.success("删除失败,数据库出错");
                            this.closeEdit();//关闭表单页面
                        }
                    }).catch(err=>{
                        this.$message.error("删除失败");
                    });
                },
                //教师修改表单
                teacherEditForm(){
                    if(tools.inputIsNullValue('#teacherName')
                        &&tools.inputIsNullValue('#teacherDepartment')){
                        let postData = {
                            name: tools.$('#teacherName').value,
                            department: tools.$('#teacherDepartment').value,
                            id:staticValue.getChoseId()
                        };
                        axios.post('/teacher/set', postData).then(val=>{
                            if(val['data']['id'] == '1'){
                                this.$message.success("修改成功");
                                this.refreshTableItems();
                                this.closeEdit();
                            }
                            if(val['data']['id'] == '2'){
                                this.$message.error("修改失败,数据库错误");
                            }
                        }).catch(err=>{
                            this.$message.error("修改失败,网络错误");
                        });
                    }else{
                        this.$message.error("请填写完整信息");
                    }
                },
                //教师添加表单
                teacherAddForm(formName){
                    this.$refs[formName].validate((valid) => {
                        if (valid) {
                            let postData = {
                                teacherId: this.teacherAdd['teacherId'],
                                name: this.teacherAdd['teacherName'],
                                department: this.teacherAdd['teacherDepartment'],
                            };
                            axios.post('/teacher/add', postData).then(val=>{
                                if(val['data']['id'] == '1'){
                                    this.$message.success("添加成功");
                                    this.refreshTableItems();
                                    this.closeEdit();
                                }
                                if(val['data']['id'] == '2'){
                                    this.$message.error("添加失败,数据库错误");
                                }
                            }).catch(err=>{
                                this.$message.error("添加失败");
                            });
                        } else {
                            this.$message.error("请填写完整信息");
                            return false;
                        }
                    });
                },
                //教师删除
                deleteTeacher(){
                    axios.post('/teacher/delete',tools.buildFormData({id:staticValue.getChoseId()})).then(async val=>{
                        if(val['data']['id'] == 1){
                            this.$message.success("删除成功");
                            this.refreshBtn();//刷新
                            this.closeEdit();//关闭表单页面
                        }
                        if(val['data']['id'] == 2){
                            this.$message.error("删除失败,数据库出错");

                            this.closeEdit();//关闭表单页面
                        }
                    }).catch(err=>{
                        this.$message.error("删除失败，网络错误");
                    });
                },
                //选题添加表单
                topicAddForm(formName){
                    this.$refs[formName].validate((valid) => {
                        if (valid) {
                            // private String       title;
                            // private String       content;
                            // private String       teacherId;
                            // private int          difficult;
                            // private String       source;
                            // private List<String> tags;
                            let tipArr = [];//所有的标签
                            console.log(staticValue.getThat().topicAdd.topicTags);
                            for(let key in staticValue.getThat().topicAdd.topicTags)
                            {
                                tipArr.push( staticValue.getThat().topicAdd.topicTags[key]['value']);
                            }
                            let topicData={
                                title:this.topicAdd['topicId'],
                                content:this.topicAdd['topicContent'],
                                teacherId:this.topicAdd['topicTeacher'],
                                difficult:this.topicAdd['topicDifficult'],
                                source:this.topicAdd['topicSource'],
                                tags:tipArr
                            }
                            axios.post('/subject/add', topicData).then(val=>{
                                const id = val['data']['id'];
                                if(id == 1){
                                    this.$message.success("选题添加成功");
                                    this.closeEditAndRefresh();//关闭并刷新
                                }
                                if(id == 2){
                                    this.$message.error("格式化错误");
                                    console.log(this.topicAdd.topicTags);
                                }
                                if(id == 3){
                                    this.$message.error("数据库出错");
                                }
                            }).catch(err=>{
                                this.$message.error("选题添加失败")
                            });
                        }
                    });
                },
                //编辑选题标签
                topicTagEditForm(){
                    this.$message.success("修改没用,关了吧")
                    console.log(staticValue.getThat().topicTagEdit['topicTags']);
                },
                //编辑选题
                topicEditForm(){
                    console.log(staticValue.getEditMainThis().topicEdit);
                    let teacherId = staticValue.getEditMainThis().topicEdit['topicTeacher']?staticValue.getEditMainThis().topicEdit['topicTeacher']:tools.$('#topicTeacher').getAttribute('defaultTeacherId');
                    let difficult = staticValue.getEditMainThis().topicEdit['topicDifficult']?staticValue.getEditMainThis().topicEdit['topicDifficult']:tools.$('#topicDifficult').getAttribute('defaultDifficult');

                    if(tools.inputIsNullValue('#topicId')
                        &&tools.inputIsNullValue('#topicContent')
                        &&tools.inputIsNullValue('#topicSource')){
                        let postData = {
                            title:tools.$('#topicId').value,
                            content:tools.$('#topicContent').value,
                            teacherId:teacherId,
                            source:tools.$('#topicSource').value,
                            difficult:parseInt(difficult)
                        };
                        axios.post(`/subject/set?id=${staticValue.getChoseId()}`, postData).then(val=>{
                            let id = val['data']['id'];
                            if(id == '1'){
                                this.$message.success("修改成功");
                                this.refreshTableItems();
                                this.closeEdit();
                            }
                            if(id == '2'){
                                this.$message.error("修改失败,格式化错误");
                            }
                            if(id == '3'){
                                this.$message.error("修改失败,数据库错误");
                            }
                        }).catch(err=>{
                            this.$message.error("修改失败,网络错误");
                        });
                    }else{
                        this.$message.error("请填写完整信息");
                    }
                },
                //删除选题
                deleteTopic(){
                    axios.post('/subject/delete',tools.buildFormData({id:staticValue.getChoseId()})).then(async val=>{
                        if(val['data']['id'] == 1){
                            this.$message.success("删除成功");
                            this.refreshBtn();//刷新
                            this.closeEdit();//关闭表单页面
                        }
                        if(val['data']['id'] == 2){
                            this.$message.success("删除失败,数据库出错");

                            this.closeEdit();//关闭表单页面
                        }
                    }).catch(err=>{
                        this.$message.error("删除失败");
                    });
                },
                //添加公告
                noticeAddForm(formName){
                    this.$refs[formName].validate((valid) => {
                        if (valid) {
                            axios.post('/announcement/add',tools.buildFormData({content:staticValue.getEditMainThis().noticeAdd.noticeContent})).then(val=>{
                                let id = val['data']['id'];
                                if(id == 1){
                                    this.$message.success('公告创建成功');
                                    this.closeEditAndRefresh();//关闭并刷新
                                }
                                if(id == 2){
                                    this.$message.error('公告内容不能为空');
                                }
                                if(id == 3){
                                    this.$message.error('公告内容不能大于500字');
                                }
                                if(id == 4){
                                    this.$message.error('数据库错误');
                                }
                            }).catch(err=>{
                                this.$message.error('网络错误');
                            })
                        }
                    });
                },
                //编辑公告
                noticeEditForm(){
                    if(tools.inputIsNullValue('#noticeContent')){
                        let postData = {
                            content: tools.$('#noticeContent').value,
                            id:staticValue.getChoseId()
                        };
                        axios.post('/announcement/set',tools.buildFormData(postData)).then(val=>{
                            let id = val['data']['id'];
                            if(id == '1'){
                                this.$message.success("修改成功");
                                this.refreshTableItems();
                                this.closeEdit();
                            }
                        }).catch(err=>{
                            this.$message.error("修改失败,网络错误");
                        });
                    }else{
                        this.$message.error("请填写完整信息");
                    }
                },
                //删除公告
                deleteNotice(){
                    console.log(staticValue.getChoseId())
                    axios.post('/announcement/delete',tools.buildFormData({id:staticValue.getChoseId()})).then(async val=>{
                        let id = val['data']['id'];
                        if(id == 1){
                            this.$message.success("删除成功");
                            this.refreshBtn();//刷新
                            this.closeEdit();//关闭表单页面
                        }
                        if(id == 2){
                            this.$message.error("删除失败,格式化错误");
                        }
                        if(id == 3){
                            this.$message.error("删除失败,数据库出错");
                        }
                    }).catch(err=>{
                        this.$message.error("删除失败,网络错误");
                    });
                },
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //                    查询功能                    //
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                selectTableItems() {

                },
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //                      杂                       //
                // ▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼▲▼//
                //登出
                loginOut(){
                    if(tools.getCookie('loginUserName') != ''){
                        tools.setTimeOutP(0,()=>{
                            tools.clearCookie('loginUserName');
                        }).then(()=>{
                            tools.jump('/');
                        });
                    }else{
                        this.$message.warning('您已登出该账号,请刷新页面');
                    }
                },
                //初始化教师下拉框数据
                async teacherSelectList(){
                    let teacherList = [];
                    let teacherData = await tools.getAxiosData('/teacher/list');
                    teacherData['data']['data'].forEach((items,index)=>{
                        teacherList.push({
                            value:`${items['teacherId']}--${items['name']}`,
                            key:items['id']
                        })
                    });
                    staticValue.getEditMainThis().$set(staticValue.getEditMainThis().topicSelect,'teacher',teacherList);
                },
                //选题和编辑标题添加标签
                addTags(elementId,tagValueSource,isEdit = false){
                    let tagValue =  this[tagValueSource].topicOneTag;
                    if(tagValue){
                        let isRepeat = false;//判断是否重复
                        staticValue.getThat()[tagValueSource].topicTags.forEach((items,index)=>{
                            if(items['value'] == tagValue || items['name'] == tagValue){
                                this.$message.error("请不要添加重复的标签");
                                isRepeat = true;
                            }
                        })
                        if(!isRepeat){
                            //如果是编辑页的添加
                            if(isEdit){
                                console.log(staticValue.getChoseId());
                                axios.post('/tag/add',tools.buildFormData({tagName:tagValue,subjectId:staticValue.getChoseId()})).then(async val=>{
                                   let id = val['data']['id'];
                                    if(id == 1){
                                        this.$message.success("插入成功");
                                        tools.$(`#topicTagsExit`).innerHTML = '';//清空
                                        console.log('asd');
                                        //初始化
                                        let tipData = await tools.getAxiosData(`/tag/list?subjectId=${staticValue.getChoseId()}`);
                                        staticValue.getThat().$set(staticValue.getThat().topicTagEdit,'topicTags',tipData['data']['data'])
                                        let tagsArr = staticValue.getThat().topicTagEdit['topicTags'];//标签数组
                                        staticValue.getThat().topicTagEdit['topicTags'].forEach((items, index)=>{
                                            //添加小标签
                                            let tagDiv=document.createElement("div");
                                            tagDiv.className = 'nmTag';
                                            tagDiv.innerHTML = `${items['name']}
                                                <div id="removeTag_${items['id'].toString()}" class="nmTagDelete" val="${items['name']}">
                                                    <i class="el-icon-close"></i>
                                                </div>`;
                                            tools.$(`#topicTagsExit`).appendChild(tagDiv);
                                            //添加标签删除功能
                                            tools.$(`#removeTag_${items['id'].toString()}`).addEventListener('click',function(){
                                                axios.post('/tag/delete',tools.buildFormData({tagId:items['id'].toString(),subjectId:staticValue.getChoseId()})).then(val=>{
                                                    let id = val['data']['id'];
                                                    if(id == 1){
                                                        staticValue.getThat().$message.success("删除成功");
                                                        //删除数组的值
                                                        tagsArr.forEach((items,index)=>{
                                                            if(items['value'] == this.getAttribute('val') || items['name'] == this.getAttribute('val') ){
                                                                delete tagsArr[index];
                                                            }
                                                        });
                                                        this.parentNode.parentNode.removeChild(this.parentNode);//删除节点
                                                    }
                                                    if(id == 2){
                                                        this.$message.error("格式化错误");
                                                    }
                                                    if(id == 3){
                                                        this.$message.error("数据库错误");
                                                    }
                                                });
                                            });
                                        });

                                    }
                                    if(id == 2){
                                        this.$message.error("id格式化错误");
                                    }
                                    if(id == 3){
                                        this.$message.error("无效课题id");
                                    }
                                    if(id == 4){
                                        this.$message.error("标签名不能为空");
                                    }
                                    if(id == 5){
                                        this.$message.error("数据库错误");
                                    }

                                }).catch(err=>{
                                    console.log(err);
                                    this.$message.error('网络异常');
                                });
                            }else{
                                //数组插入标签
                                let tagsArr =staticValue.getThat()[tagValueSource].topicTags;
                                tagsArr.push({
                                    value:tagValue
                                });
                                //添加小标签
                                let tagDiv=document.createElement("div");
                                tagDiv.className = 'nmTag';
                                tagDiv.innerHTML = `${tagValue}
                                                    <div id="removeTag_${tagValue}" class="nmTagDelete" val="${tagValue}">
                                                        <i class="el-icon-close"></i>
                                                    </div>`;
                                tools.$(`#${elementId}`).appendChild(tagDiv);

                                //添加标签删除功能
                                tools.$(`#removeTag_${tagValue}`).addEventListener('click',function () {
                                    //删除数组的值
                                        tagsArr.forEach((items,index)=>{
                                            if(items['value'] == this.getAttribute('val') || items['name'] == this.getAttribute('val') ){
                                                delete tagsArr[index];
                                            }
                                        });
                                        this.parentNode.parentNode.removeChild(this.parentNode);//删除节点
                                });
                            }
                        }
                        this.$set(this[tagValueSource],'topicOneTag','');
                    }else{
                        this.$message.error("添加的标签内容不能为空");
                    }
                },
                //刷新按钮
                async refreshBtn(){
                    if(staticValue.getCurrentPage() == '1'){
                        let studentData = await tools.getAxiosData('/student/list?page=1&pageSize=8');
                        staticValue.getThat().refreshTables(1,studentData['data']['total'],8);
                    }
                    //教师页刷新
                    if(staticValue.getCurrentPage() == '2'){
                        let teacherData = await tools.getAxiosData('/teacher/list?page=1&pageSize=8');
                        staticValue.getThat().refreshTables(1,teacherData['data']['total'],8);
                    }
                    //选题页刷新
                    if(staticValue.getCurrentPage() == '3'){
                        let subjectData = await tools.getAxiosData('/subject/list?page=1&pageSize=4');
                        staticValue.getThat().refreshTables(1,subjectData['data']['total'],4);
                    }
                    //公告页刷新
                    if(staticValue.getCurrentPage() == '5'){

                        staticValue.getThat().refreshTables(0,0,0);
                    }
                    this.$message('刷新成功');
                    new app().$mount("#mainContent");
                },
                //单页面刷新
                async refreshTableItems() {
                    //学生页刷新
                    if(staticValue.getCurrentPage() == '1'){
                        let studentData = await tools.getAxiosData(`/student/list?page=${staticValue.getPageNumber()}&pageSize=8`);
                        tools.$('#tableDate').innerHTML = await tableModel.getStudentTableData(studentData['data']['data']);
                    }
                    //教师页刷新
                    if(staticValue.getCurrentPage() == '2'){
                        let teacherData = await tools.getAxiosData(`/teacher/list?page=${staticValue.getPageNumber()}&pageSize=8`);
                        tools.$('#tableDate').innerHTML = await tableModel.getTeacherTableData(teacherData['data']['data']);
                    }
                    //选题页刷新
                    if(staticValue.getCurrentPage() == '3'){
                        let subjectData = await tools.getAxiosData(`/subject/list?page=${staticValue.getPageNumber()}&pageSize=4`);
                        tools.$('#tableDate').innerHTML = await tableModel.getTopicTableData(subjectData['data']['data']);
                    }
                    //公告页刷新
                    if(staticValue.getCurrentPage() == '5'){
                        let noticeData = await tools.getAxiosData('/announcement/list');
                        tools.$('#currentNotices').innerHTML = await tableModel.getNoticeData(noticeData['data']['data']);
                    }
                    new app().$mount("#mainContent");
                },
                //切换页面刷新
                refreshTables(nowPage,totalData,pageSize){
                    console.log(pageSize)
                    staticValue.getThat().$set(staticValue.getThat().pageInfo,'nowPage',nowPage);
                    staticValue.getThat().$set(staticValue.getThat().pageInfo,'pageSize',pageSize);
                    staticValue.getThat().$set(staticValue.getThat().pageInfo,'totalData',totalData);
                    staticValue.setPageNumber(nowPage);
                    this.refreshTableItems();
                },
                //换页
                async handleCurrentChange(val) {
                    this.$set(this.pageInfo,'nowPage',val);
                    staticValue.setPageNumber(this.pageInfo['nowPage']);
                    //学生换页
                    this.refreshTableItems();
                }
            }
        });
        new app().$mount("#app");


    })();

</script>
</html>