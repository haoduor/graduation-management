<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录页</title>
    <link rel="stylesheet" href="/css/login.css">
    <link rel="stylesheet" href="/css/admin/index.css">
    <link rel="stylesheet" href="/css/globel.css">
    <link rel="stylesheet" href="/css/element.css">
    <link rel="stylesheet" href="/css/frame.css">
    <link rel="stylesheet" href="/css/lTable.css">

</head>

<body class="loginBk">
    <div id="app">

        <div class="loginBody">
<!--            登录表单-->
            <div id="loginForm" class="loginForm"></div>
<!--            登录公告-->
            <div id="loginMsg" class="loginMsg"></div>
        </div>
    </div>
</body>
<script src="/js/tool.js" type="module"></script>
<script src="/js/vue.js" type="module"></script>
<script src="/js/element.js" type="module"></script>
<script src="/js/axios.js"></script>
<script type="module">
    import { tools } from './js/tool.js';
    import { tableModel } from './js/tableModel.js';
    (async () => {
        await tools.setPage('loginForm', './view/login/loginForm.html');//绑定表单
        await tools.setPage('loginMsg', './view/login/loginMsg.html');//绑定公告

        // 设置登录页背景图片
        //document.getElementById
        tools.$('.loginBk').style.background = `url(/image/Sola.png)`;
        //初始化公告FFF
        let noticeData = await tools.getAxiosData('/announcement/list');
        //将数据绑定到公告页面上
        tools.$('#msgBody').innerHTML = await tableModel.getLoginNoticeData(noticeData['data']['data']);
        var app = Vue.extend({
            data() {
                return {
                    rules: {
                        username: [
                            { required: true, message: '请输入用户名', trigger: 'blur' }
                        ],
                        password: [
                            { required: true, message: '请输入密码', trigger: 'blur' }
                        ],
                    },
                    loginForm: {
                        username: '',
                        password: '',
                    },
                    topicItems: ['1','2','3']
                }
            },
            mounted:function(){

            },
            //方法
            methods: {
                // 登录事件
                submitForm(formName) {
                    //表单验证，框架模板
                    this.$refs[formName].validate(async (valid) => {
                        if (valid) {

                            let userData = {
                                username: this.loginForm.username,
                                password: this.loginForm.password,
                                code:''
                            };
                            try {

                                let loginResult = await axios.post('/login', tools.buildFormData(userData));
                                if(loginResult['data']['id'] == 1 ){
                                    tools.setTimeOutP(3000,()=>{
                                        this.$message.success("3秒后将跳转");
                                        tools.setCookie('loginUserName',this.loginForm.username,1);
                                    }).then(val=>{
                                        tools.jump('/');//刷新当前页面，由后台重定向路由
                                    });
                                }else{
                                    this.$message.error(loginResult['data']['message']);
                                }

                            } catch {
                                this.$message.error("网络出错了")
                            }
                        } else {
                            alert('请输入完整信息');
                            return false;
                        }
                    });
                },
            }
        });
        var fin = new app().$mount("#app");
    })();

</script>

</html>